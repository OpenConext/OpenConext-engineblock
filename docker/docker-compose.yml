---
services:

    mariadb:
        image: mariadb:10.7
        restart: always
        container_name: eb-db-test
        environment:
            MYSQL_ROOT_PASSWORD: "root"
            MYSQL_DATABASE: "eb_test"
            MYSQL_USER: "eb_testrw"
            MYSQL_PASSWORD: "secret"
            MYSQL_INITDB_SKIP_TZINFO: 1
        volumes:
            - eb-mysql-test-data:/var/lib/mysql
        healthcheck:
            test: ["CMD-SHELL", "mysqladmin --user=root --password=$${MYSQL_ROOT_PASSWORD} ping"]
            timeout: 2s
            retries: 20
            interval: 2s

    engine:
        build:
            context: ../
            # override this in a dedicated dockerfile per php version
            # dockerfile: docker/ci/Dockerfile
        hostname: engine.dev.openconext.local
        depends_on:
            mariadb:
                condition: service_healthy
        environment:
            APP_ENV: ci
            SYMFONY_ENV: ci
            APACHE_UID: "#${APACHE_UID}"
            APACHE_GUID: "#${APACHE_GID}"
        volumes:
            - ../:/var/www/html
            - ../ci/qa-config/files/engine.dev.openconext.local.crt:/config/engine/engineblock.crt
            - ../ci/qa-config/files/engine.dev.openconext.local.key:/config/engine/engineblock.pem
            # NB: we can't use bind mounts for these dirs, as they need to be chowned to the openconext user
            -   type: tmpfs
                target: /var/www/html/app/cache
                tmpfs: {size: "128M"}
            -   type: tmpfs
                target: /var/www/html/app/logs
                tmpfs: {size: "128M"}
            -   type: tmpfs
                target: /tmp
                tmpfs: {size: "1024M"}
        healthcheck:
            test: ["CMD-SHELL", "curl -sI http://localhost/| grep '^Server: Apache'"]
            timeout: 2s
            retries: 20
            interval: 5s

    selenium:
        image: selenium/standalone-chrome:2.53.1
        hostname: selenium.dev.openconext.local
        # NB: Selenium2 is OLD and doesn't have arm64 images; to run this on arm64, you need Rosetta enabled
        platform: amd64
        shm_size: 2gb
#        environment:
#            START_XVFB: "false"
        healthcheck:
            test: ["CMD", "/opt/bin/check-grid.sh:", "--host", "0.0.0.0", "--port", "4444"]
            timeout: 30s
            retries: 5
            interval: 15s

    cypress:
        image: "cypress/included:13.1.0"
        platform: amd64
        environment:
            - CYPRESS_baseUrl=https://engine.dev.openconext.local
        working_dir: /e2e
        entrypoint: cypress open --project .
        volumes:
            - ../tests:/e2e
            - ../theme:/theme

volumes:
    eb-mysql-test-data:
