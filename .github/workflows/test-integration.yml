name: test-integration
on:
    push:
    pull_request:
    # run at 6 hour UTC
    schedule:
        -   cron: "0 6 * * *"
jobs:
    build:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
            matrix:
                # php82 is ready to run alongside the 72, but is not enabled now as the code is not 82 compatible yet
                php: [ php72 ]
        env:
            PROD_PHP: "${{matrix.php}}"
        steps:
            -   name: Checkout
                uses: actions/checkout@master

            -   name: Build Docker environmnent
                run: |
                    cd docker && ./docker-setup.sh

            -   name: debug
                run: |
                    docker inspect eb-engine-1
                    ps aux
                    ls -laR app

            -   name: Run tests
                run: |
                    cd docker && ./docker-runtests.sh

            -   name: Show log on failure
                if: failure()
                run: |
                    docker inspect eb-engine-1
                    ps aux
                    ls -laR app
                    cd docker && docker compose exec -T engine cat /var/www/html/app/logs/ci/ci.log

            -   name: Send notification on production build nightly build failure
                uses: sonots/slack-notice-action@v3
                with:
                    status: ${{ job.status }}
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
                if: ${{ failure() && github.event_name == 'schedule' && matrix.php == env.PROD_PHP }}
